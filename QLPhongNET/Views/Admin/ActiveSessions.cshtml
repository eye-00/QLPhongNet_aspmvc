@{
    ViewData["Title"] = "Theo dõi phiên sử dụng";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@ViewData["Title"]</h2>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="activeSessionsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Người dùng</th>
                            <th>Máy tính</th>
                            <th>Danh mục</th>
                            <th>Thời gian bắt đầu</th>
                            <th>Thời gian sử dụng</th>
                            <th>Chi phí</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Hàm định dạng thời gian
            function formatDuration(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = Math.floor(minutes % 60);
                return `${hours} giờ ${mins} phút`;
            }

            // Hàm định dạng tiền tệ
            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
            }

            // Hàm cập nhật dữ liệu
            function updateActiveSessions() {
                $.ajax({
                    url: '/Admin/GetActiveSessions',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        var tbody = $('#activeSessionsTable tbody');
                        tbody.empty();
                        
                        if (data && data.length > 0) {
                            data.forEach(function(session) {
                                var row = $('<tr>');
                                row.append($('<td>').text(session.userName));
                                row.append($('<td>').text(session.computerName));
                                row.append($('<td>').text(session.categoryName));
                                row.append($('<td>').text(new Date(session.startTime).toLocaleString('vi-VN')));
                                row.append($('<td>').text(formatDuration(session.duration)));
                                row.append($('<td>').text(formatCurrency(session.cost)));
                                tbody.append(row);
                            });
                        } else {
                            tbody.append('<tr><td colspan="6" class="text-center">Không có phiên sử dụng nào đang hoạt động</td></tr>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Lỗi khi lấy dữ liệu:', error);
                        console.error('Chi tiết lỗi:', xhr.responseText);
                        $('#activeSessionsTable tbody').html('<tr><td colspan="6" class="text-center text-danger">Đã xảy ra lỗi khi tải dữ liệu: ' + error + '</td></tr>');
                    }
                });
            }

            // Cập nhật lần đầu
            updateActiveSessions();
            
            // Cập nhật mỗi 5 giây
            setInterval(updateActiveSessions, 5000);
        });
    </script>
} 