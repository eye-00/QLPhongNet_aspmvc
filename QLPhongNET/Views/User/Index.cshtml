@model IEnumerable<QLPhongNET.Models.Computer>
@{
    ViewData["Title"] = "Trang chủ";
    var currentUser = ViewBag.CurrentUser as QLPhongNET.Models.User;
    var currentSession = ViewBag.CurrentSession as QLPhongNET.Models.UsageSession;
    var services = ViewBag.Services as IEnumerable<QLPhongNET.Models.Service>;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Thông tin người dùng</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Tên đăng nhập:</strong> @User.Identity?.Name</p>
                            <p><strong>Số dư:</strong> @ViewBag.Balance?.ToString("N0") VNĐ</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Phiên sử dụng hiện tại:</strong></p>
                            @if (ViewBag.CurrentSession != null)
                            {
                                <p>Máy: @ViewBag.CurrentSession.Computer?.Name</p>
                                <p>Bắt đầu: @ViewBag.CurrentSession.StartTime.ToString("dd/MM/yyyy HH:mm:ss")</p>
                                <p>Thời gian sử dụng: <span id="usageTime">0:00:00</span></p>
                                <p>Chi phí hiện tại: <span id="currentCost">0</span> VNĐ</p>
                                <a href="@Url.Action("EndSession", "User", new { sessionId = ViewBag.CurrentSession.ID })" 
                                   class="btn btn-danger" onclick="return confirm('Bạn có chắc muốn kết thúc phiên sử dụng?')">
                                    Kết thúc phiên
                                </a>
                            }
                            else
                            {
                                <p>Không có phiên sử dụng nào</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Danh sách máy tính</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var computer in Model)
                        {
                            <div class="col-md-3 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">@computer.Name</h5>
                                        <p class="card-text">
                                            <strong>Loại:</strong> @computer.Category?.Name<br>
                                            <strong>Giá:</strong> @computer.Category?.PricePerHour.ToString("N0") VNĐ/giờ<br>
                                            <strong>Trạng thái:</strong>
                                            @switch (computer.Status)
                                            {
                                                case ComputerStatus.Available:
                                                    <span class="badge bg-success">Sẵn sàng</span>
                                                    break;
                                                case ComputerStatus.InUse:
                                                    <span class="badge bg-danger">Đang sử dụng</span>
                                                    break;
                                                case ComputerStatus.Maintenance:
                                                    <span class="badge bg-warning">Bảo trì</span>
                                                    break;
                                            }
                                        </p>
                                        @if (computer.Status == ComputerStatus.Available)
                                        {
                                            <a href="@Url.Action("StartSession", "User", new { computerId = computer.ID })" 
                                               class="btn btn-primary" onclick="return confirm('Bạn có chắc muốn bắt đầu sử dụng máy này?')">
                                                Bắt đầu sử dụng
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function updateUsageTime() {
            const startTime = new Date('@ViewBag.CurrentSession?.StartTime.ToString("o")');
            if (startTime) {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                document.getElementById('usageTime').textContent = 
                    `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const pricePerHour = @ViewBag.CurrentSession?.Computer?.Category?.PricePerHour ?? 0;
                const currentCost = Math.ceil(diff / 3600) * pricePerHour;
                document.getElementById('currentCost').textContent = currentCost.toLocaleString('vi-VN');
            }
        }

        if (document.getElementById('usageTime')) {
            setInterval(updateUsageTime, 1000);
            updateUsageTime();
        }
    </script>
} 